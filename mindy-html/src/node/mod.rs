use std::collections::HashSet;
use std::iter::once;
use ammonia::{clean, Builder, UrlRelative};
use dioxus::logger::tracing;
use dioxus::prelude::*;
use mindy_engine::node::style::NodeStyle;
use mindy_engine::node::Node;
use mindy_engine::layout::pos2::Pos2;

#[derive(Props, PartialEq, Clone)]
pub struct NodeProps {
    pub node: Node,
}

#[component]
pub fn NodeComp(props: NodeProps) -> Element {

    let NodeStyle {
        background_color,
        text_wrapping,
        font_size,
        font_family,
        padding,
        max_width,
        min_width,
        ..
    } = props.node
        .clone()
        .style_custom
        .clone();

    let background_color = background_color.unwrap_or_default();
    tracing::debug!("node style - background_color: {:?} - font_size: {:?}", background_color, font_size);

    let Pos2 { x: pos_x, y: pos_y } = props.node.clone().position_real.unwrap_or_default();
    let text = props.node.text.clone().unwrap_or_else(|| "".to_string());
    let text_wrap = if text_wrapping { "wrap" } else { "nowrap" };

    let clean_ignore_tags = HashSet::from(["img"]);
    let html = "<div>test<img width=\"50px\"  src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDUxMiA1MTIiPgogIDxwYXRoIGQ9Ik0gMTg3LDE0MSBMIDE4NSwxNDMgTCAxODQsMTQzIEwgMTQwLDE4NyBMIDE0MCwxODggTCAxMzksMTg5IEwgMTM5LDE5MCBMIDEzOCwxOTEgTCAxMzgsMjk5IEwgMTM5LDMwMCBMIDEzOSwzMDEgTCAxNDAsMzAyIEwgMTQwLDMwMyBMIDE0MSwzMDQgTCAxNDAsMzA1IEwgMTQxLDMwNCBMIDE0MywzMDYgTCAxNDQsMzA2IEwgMTQ1LDMwNyBMIDE1MCwzMDcgTCAxNTEsMzA2IEwgMTUyLDMwNiBMIDE1NSwzMDMgTCAxNTUsMzAyIEwgMTU2LDMwMSBMIDE1NiwxOTUgTCAxNTksMTkyIEwgMTYwLDE5MiBMIDE2MCwxOTEgTCAxNjcsMTg0IEwgMTY4LDE4NCBMIDE3MCwxODIgTCAxNzAsMTgxIEwgMTcxLDE4MCBMIDE3MiwxODAgTCAxNzIsMTc5IEwgMTc1LDE3NiBMIDE3NiwxNzYgTCAxNzYsMTc1IEwgMTc5LDE3MiBMIDE4MCwxNzIgTCAxODAsMTcxIEwgMTkyLDE1OSBMIDI5OSwxNTkgTCAzMDAsMTU4IEwgMzAxLDE1OCBMIDMwMywxNTYgTCAzMDQsMTU2IEwgMzA0LDE1NSBMIDMwNSwxNTQgTCAzMDUsMTUzIEwgMzA2LDE1MiBMIDMwNiwxNDggTCAzMDUsMTQ3IEwgMzA1LDE0NiBMIDMwMSwxNDIgTCAyOTksMTQyIEwgMjk4LDE0MSBaIiBmaWxsPSIjYTg0ZmQ0IiBzdHJva2U9IiNhODRmZDQiIHN0cm9rZS13aWR0aD0iMSIvPgogIDxwYXRoIGQ9Ik0gMzU0LDEzMCBMIDM1MywxMzEgTCAzNTAsMTMxIEwgMzQ5LDEzMiBMIDM0OCwxMzIgTCAzNDYsMTM0IEwgMzQ1LDEzNCBMIDM0MiwxMzcgTCAzNDIsMTM4IEwgMzQwLDE0MCBMIDM0MCwxNDIgTCAzMzksMTQzIEwgMzM5LDE1MCBMIDM0MCwxNTEgTCAzNDAsMTUzIEwgMzA1LDE4OCBMIDMwNSwxODkgTCAzMDQsMTkwIEwgMzAzLDE5MCBMIDMwMywxOTEgTCAzMDAsMTk0IEwgMjMyLDE5NCBMIDIzMSwxOTUgTCAyMjgsMTk1IEwgMjI3LDE5NiBMIDIyNSwxOTYgTCAyMjQsMTk3IEwgMjIyLDE5NyBMIDIyMSwxOTggTCAyMjAsMTk4IEwgMjE4LDIwMCBMIDIxNywyMDAgTCAyMTMsMjA0IEwgMjEyLDIwNCBMIDIwOSwyMDcgTCAyMDksMjA4IEwgMjA3LDIxMCBMIDIwNywyMTEgTCAyMDYsMjEyIEwgMjA2LDIxMyBMIDIwNSwyMTQgTCAyMDUsMjE1IEwgMjA0LDIxNiBMIDIwNCwyMTcgTCAyMDMsMjE4IEwgMjAzLDIyMCBMIDIwMiwyMjEgTCAyMDIsMjI2IEwgMjAxLDIyNyBMIDIwMSwyMzYgTCAyMDIsMjM3IEwgMjAyLDI0MCBMIDIwMywyNDEgTCAyMDMsMjQzIEwgMjA0LDI0NCBMIDIwNCwyNDUgTCAyMDcsMjQ4IEwgMjA4LDI0OCBMIDIxMCwyNTAgTCAyMDksMjUxIEwgMjEwLDI1MCBMIDIxMSwyNTAgTCAyMTIsMjUxIEwgMjEzLDI1MSBMIDIxNCwyNTIgTCAyMTUsMjUyIEwgMjE2LDI1MyBMIDIxNywyNTMgTCAyMTgsMjU0IEwgMjE5LDI1NCBMIDIyMCwyNTUgTCAyMjEsMjU1IEwgMjIyLDI1NiBMIDIyMywyNTYgTCAyMjQsMjU3IEwgMjI1LDI1NyBMIDIyNiwyNTggTCAyMjcsMjU4IEwgMjI4LDI1OSBMIDIyOSwyNTkgTCAyMzAsMjYwIEwgMjMxLDI2MCBMIDIzMiwyNjEgTCAyMzMsMjYxIEwgMjM0LDI2MiBMIDIzNSwyNjIgTCAyMzYsMjYzIEwgMjM3LDI2MyBMIDIzOCwyNjQgTCAyMzksMjY0IEwgMjQwLDI2NSBMIDI0MSwyNjUgTCAyNDIsMjY2IEwgMjQzLDI2NiBMIDI0NSwyNjggTCAyNDYsMjY4IEwgMjUwLDI3MiBMIDI1MCwyNzQgTCAyNTEsMjc1IEwgMjUxLDI3OCBMIDI1MCwyNzkgTCAyNTAsMjgxIEwgMjQ0LDI4NyBMIDI0MywyODcgTCAyNDIsMjg4IEwgMjQwLDI4OCBMIDIzOSwyODkgTCAxODYsMjg5IEwgMTM1LDM0MCBMIDEyOCwzNDAgTCAxMjcsMzQxIEwgMTI1LDM0MSBMIDEyNCwzNDIgTCAxMjMsMzQyIEwgMTIxLDM0NCBMIDEyMCwzNDQgTCAxMTgsMzQ2IEwgMTE4LDM0NyBMIDExNiwzNDkgTCAxMTYsMzUxIEwgMTE1LDM1MiBMIDExNSwzNjEgTCAxMTYsMzYyIEwgMTE2LDM2MyBMIDExNywzNjQgTCAxMTcsMzY1IEwgMTIyLDM3MCBMIDEyMywzNzAgTCAxMjQsMzcxIEwgMTI1LDM3MSBMIDEyNiwzNzIgTCAxMjgsMzcyIEwgMTI5LDM3MyBMIDEzMywzNzMgTCAxMzQsMzcyIEwgMTM3LDM3MiBMIDEzOCwzNzEgTCAxMzksMzcxIEwgMTQyLDM2OCBMIDE0MywzNjggTCAxNDQsMzY3IEwgMTQ0LDM2NiBMIDE0NiwzNjQgTCAxNDYsMzYyIEwgMTQ3LDM2MSBMIDE0NywzNTggTCAxNDgsMzU3IEwgMTQ4LDM1NiBMIDE0NywzNTUgTCAxNDcsMzUwIEwgMTUxLDM0NiBMIDE1MiwzNDYgTCAxNTIsMzQ1IEwgMTUzLDM0NCBMIDE1NCwzNDQgTCAxNTQsMzQzIEwgMTU4LDMzOSBMIDE1OSwzMzkgTCAxNjAsMzM4IEwgMTYwLDMzNyBMIDE2MiwzMzUgTCAxNjMsMzM1IEwgMTY4LDMzMCBMIDE2OCwzMjkgTCAxNjksMzI4IEwgMTcwLDMyOCBMIDE4OSwzMDkgTCAyNDMsMzA5IEwgMjQ0LDMwOCBMIDI0NywzMDggTCAyNDgsMzA3IEwgMjUwLDMwNyBMIDI1MSwzMDYgTCAyNTIsMzA2IEwgMjUzLDMwNSBMIDI1NCwzMDUgTCAyNTUsMzA0IEwgMjU2LDMwNCBMIDI1NywzMDMgTCAyNTgsMzAzIEwgMjYxLDMwMCBMIDI2MiwzMDAgTCAyNjYsMjk2IEwgMjY2LDI5NSBMIDI2OCwyOTMgTCAyNjgsMjkyIEwgMjY5LDI5MSBMIDI2OSwyOTAgTCAyNzAsMjg5IEwgMjcwLDI4OCBMIDI3MSwyODcgTCAyNzEsMjg2IEwgMjcyLDI4NSBMIDI3MiwyODEgTCAyNzMsMjgwIEwgMjczLDI3MCBMIDI3MiwyNjkgTCAyNzIsMjY2IEwgMjcxLDI2NSBMIDI3MSwyNjMgTCAyNzAsMjYyIEwgMjcwLDI2MSBMIDI2OCwyNTkgTCAyNjgsMjU4IEwgMjYwLDI1MCBMIDI1OSwyNTAgTCAyNTgsMjQ5IEwgMjU3LDI0OSBMIDI1NSwyNDcgTCAyNTQsMjQ3IEwgMjUzLDI0NiBMIDI1MiwyNDYgTCAyNTEsMjQ1IEwgMjUwLDI0NSBMIDI0OSwyNDQgTCAyNDgsMjQ0IEwgMjQ3LDI0MyBMIDI0NiwyNDMgTCAyNDUsMjQyIEwgMjQ0LDI0MiBMIDI0MywyNDEgTCAyNDIsMjQxIEwgMjQxLDI0MCBMIDI0MCwyNDAgTCAyMzksMjM5IEwgMjM4LDIzOSBMIDIzNywyMzggTCAyMzYsMjM4IEwgMjM1LDIzNyBMIDIzNCwyMzcgTCAyMzMsMjM2IEwgMjMyLDIzNiBMIDIzMSwyMzUgTCAyMzAsMjM1IEwgMjI5LDIzNCBMIDIyOCwyMzQgTCAyMjcsMjMzIEwgMjI2LDIzMyBMIDIyNSwyMzIgTCAyMjUsMjMxIEwgMjI0LDIzMCBMIDIyNCwyMjMgTCAyMjYsMjIxIEwgMjI2LDIyMCBMIDIyOSwyMTcgTCAyMzAsMjE3IEwgMjMxLDIxNiBMIDIzMiwyMTYgTCAyMzMsMjE1IEwgMjM1LDIxNSBMIDIzNiwyMTQgTCAyOTYsMjE0IEwgMjk3LDIxNSBMIDI5NiwyMTYgTCAyOTYsMjI1IEwgMjk3LDIyNiBMIDI5NywyMjcgTCAyOTYsMjI4IEwgMjk2LDMwMSBMIDI5NywzMDIgTCAyNjksMzMwIEwgMTg4LDMzMCBMIDE4NywzMzEgTCAxODYsMzMxIEwgMTg0LDMzMyBMIDE4NCwzMzQgTCAxODMsMzM1IEwgMTgzLDMzNyBMIDE4MiwzMzggTCAxODMsMzM5IEwgMTgzLDM0MSBMIDE4NSwzNDMgTCAxODUsMzQ0IEwgMTg2LDM0NCBMIDE4NywzNDUgTCAyMzMsMzQ1IEwgMjM0LDM0NiBMIDIzNCwzNjggTCAyMjgsMzc0IEwgMjI4LDM3NSBMIDIyNywzNzYgTCAyMjcsMzc3IEwgMjI2LDM3OCBMIDIyNiwzODcgTCAyMjcsMzg4IEwgMjI3LDM4OSBMIDIyOCwzOTAgTCAyMjgsMzkxIEwgMjMwLDM5MyBMIDIzMCwzOTQgTCAyMzEsMzk0IEwgMjMzLDM5NiBMIDIzNCwzOTYgTCAyMzUsMzk3IEwgMjM2LDM5NyBMIDIzNywzOTggTCAyNDYsMzk4IEwgMjQ3LDM5NyBMIDI0OCwzOTcgTCAyNDksMzk2IEwgMjUwLDM5NiBMIDI1MSwzOTUgTCAyNTIsMzk1IEwgMjU0LDM5MyBMIDI1NCwzOTIgTCAyNTYsMzkwIEwgMjU2LDM4OSBMIDI1NywzODggTCAyNTcsMzg1IEwgMjU4LDM4NCBMIDI1OCwzODEgTCAyNTcsMzgwIEwgMjU3LDM3NyBMIDI1NiwzNzYgTCAyNTYsMzc1IEwgMjU1LDM3NCBMIDI1NSwzNzMgTCAyNTIsMzcwIEwgMjUxLDM3MCBMIDI1MCwzNjkgTCAyNDksMzY5IEwgMjQ4LDM2OCBMIDI0OCwzNDYgTCAyNDksMzQ1IEwgMjc0LDM0NSBMIDI3NSwzNDQgTCAyNzYsMzQ0IEwgMjk4LDMyMiBMIDMxMSwzMzUgTCAzMTEsMzM2IEwgMzEyLDMzNiBMIDMxMywzMzcgTCAzMTMsMzM4IEwgMzE0LDMzOSBMIDMxNSwzMzkgTCAzMTcsMzQxIEwgMzE3LDM0MiBMIDMxOSwzNDQgTCAzMjAsMzQ0IEwgMzI1LDM0OSBMIDMyNSwzNTAgTCAzMjcsMzUyIEwgMzI4LDM1MiBMIDMyOSwzNTMgTCAzMjksMzU0IEwgMzMwLDM1NSBMIDMyOSwzNTYgTCAzMjksMzY2IEwgMzMwLDM2NyBMIDMzMCwzNjggTCAzMzIsMzcwIEwgMzMyLDM3MSBMIDMzMywzNzIgTCAzMzQsMzcyIEwgMzM2LDM3NCBMIDMzNywzNzQgTCAzMzgsMzc1IEwgMzM5LDM3NSBMIDM0MCwzNzYgTCAzNDksMzc2IEwgMzUwLDM3NSBMIDM1MiwzNzUgTCAzNTQsMzczIEwgMzU1LDM3MyBMIDM1OCwzNzAgTCAzNTgsMzY5IEwgMzU5LDM2OCBMIDM1OSwzNjcgTCAzNjAsMzY2IEwgMzYwLDM2NCBMIDM2MSwzNjMgTCAzNjEsMzU2IEwgMzYwLDM1NSBMIDM2MCwzNTQgTCAzNTksMzUzIEwgMzU5LDM1MiBMIDM1OCwzNTEgTCAzNTgsMzUwIEwgMzU2LDM0OCBMIDM1NSwzNDggTCAzNTMsMzQ2IEwgMzUyLDM0NiBMIDM1MSwzNDUgTCAzNDgsMzQ1IEwgMzQ3LDM0NCBMIDM0MywzNDQgTCAzNDIsMzQ1IEwgMzQxLDM0NSBMIDMzMSwzMzUgTCAzMzAsMzM1IEwgMzI5LDMzNCBMIDMyOSwzMzMgTCAzMjUsMzI5IEwgMzI0LDMyOSBMIDMyMywzMjggTCAzMjMsMzI3IEwgMzA4LDMxMiBMIDMxMywzMDcgTCAzMTMsMjY2IEwgMzEyLDI2NSBMIDMxMywyNjQgTCAzNjUsMjY0IEwgMzY2LDI2NSBMIDM2NiwyNjYgTCAzNjksMjY5IEwgMzcwLDI2OSBMIDM3MSwyNzAgTCAzNzIsMjcwIEwgMzczLDI3MSBMIDM3NSwyNzEgTCAzNzYsMjcyIEwgMzgzLDI3MiBMIDM4NCwyNzEgTCAzODYsMjcxIEwgMzg3LDI3MCBMIDM4OCwyNzAgTCAzOTQsMjY0IEwgMzk0LDI2MyBMIDM5NSwyNjIgTCAzOTUsMjYxIEwgMzk2LDI2MCBMIDM5NiwyNTAgTCAzOTUsMjQ5IEwgMzk1LDI0NyBMIDM5MywyNDUgTCAzOTMsMjQ0IEwgMzkwLDI0MSBMIDM4OSwyNDEgTCAzODcsMjM5IEwgMzg1LDIzOSBMIDM4NCwyMzggTCAzNzQsMjM4IEwgMzczLDIzOSBMIDM3MiwyMzkgTCAzNzEsMjQwIEwgMzcwLDI0MCBMIDM2NCwyNDYgTCAzMTQsMjQ2IEwgMzEzLDI0NSBMIDMxMywyMDUgTCAzMjAsMTk4IEwgMzIwLDE5NyBMIDMyOCwxODkgTCAzMjgsMTg4IEwgMzM4LDE3OCBMIDMzOCwxNzcgTCAzNDgsMTY3IEwgMzQ4LDE2NiBMIDM1MSwxNjMgTCAzNTMsMTYzIEwgMzU0LDE2NCBMIDM1OSwxNjQgTCAzNjAsMTYzIEwgMzYzLDE2MyBMIDM2NSwxNjEgTCAzNjYsMTYxIEwgMzcxLDE1NiBMIDM3MSwxNTUgTCAzNzIsMTU0IEwgMzcyLDE1MiBMIDM3MywxNTEgTCAzNzMsMTQzIEwgMzcyLDE0MiBMIDM3MiwxNDAgTCAzNzAsMTM4IEwgMzcwLDEzNyBMIDM2NiwxMzMgTCAzNjUsMTMzIEwgMzY0LDEzMiBMIDM2MywxMzIgTCAzNjIsMTMxIEwgMzU5LDEzMSBMIDM1OCwxMzAgWiIgZmlsbD0iIzAwYzRmZiIgc3Ryb2tlPSIjMDBjNGZmIiBzdHJva2Utd2lkdGg9IjEiLz4KPC9zdmc+\" /></div>";
    let safe_html = Builder::default()
        .add_url_schemes(&["data"])
        .url_relative(UrlRelative::PassThrough)
        .clean(html)
        .to_string();

    rsx! {
        div {
            class: "node",
            style: "background-color: {background_color.hex};",
            style: "min-width: {min_width}px;",
            style: "max-width: {max_width}px;",
            style: "max-height: 900px;",
            style: "text-wrap: {text_wrap};",
            style: "font-size: {font_size}px;",
            style: "padding: {padding}px;",
            style: "font-family: {font_family};",
            style: "font-size: {font_size}px;",
            top: "{pos_y}px",
            left: "{pos_x}px",
            id: "test",
            dangerous_inner_html: "{safe_html}",
            // "{text}",
        }
    }
}
